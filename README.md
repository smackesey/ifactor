# IFactor

IFactor is a NeoVim-based interactive refactoring tool similar in spirit to
[CodeMod](https://github.com/facebookarchive/codemod).

## Overview

The function of IFactor is to interactively process a stream of matches from a
[Treesitter query][ts-query]. Each query match is mapped to a text diff using a
user-provided diff-generation function. The target buffer is copied to a
temporary buffer, the diff is applied to it, and the temporary buffer is
presented in a in a Vim split alongside the original text. The user then has
the opportunity to edit the temporary buffer. At any time, the user can
*accept* or *reject* the changes. Accepting the changes will write the source
file and rejecting the changes will leave the file unchanged. In either case,
IFactor will move on to the next match.

[ts-query]: https://tree-sitter.github.io/tree-sitter/using-parsers#pattern-matching-with-queries.

The core abstraction of IFactor is the *transform*. A transform combines a
Treesitter query, a filter function over the query matches, and a diff function
that maps query matches to text diffs. Transforms can be applied to arbitrary
sets of files, with the stream of query matches generated by iterating over
each file.

Application of a transform happens at the user's chosen pace. When a transform
is in the middle of being applied (e.g. the user is paused at a match in the
middle of the stream), we say that the transform is "active".

Only a single transform may be active at a time. The active transform is
encapsulated in the IFactor *instance*, which enforces the single-transform
rule by existing as a singleton within a Neovim process. The UI of an IFactor
instance lives inside a single tabpage.

## Usage

IFactor allows only a single instance at a time. This is encapsulated
in an instance of the `Instance` class, defined in `ifactor.instance`. Each
instance is bound to a single transform (see below). When a particular
transform is completed or aborted, the current instance is destroyed so that a
new one may be created.

An `Instance` is parameterized with a set of *globs*, a *transform*, and some
options.

The **globs** are Vim globs, passed directly to `vim.fn.glob`. These support
regular (`*`) and recursive (`**`) wildcards. You can find the full
specification in Neovim's help. The globs are used to resolve a set of files
for the instance to process.

The **transform** is a table with a *query*, *language*, *diff function*, and
an optional *filter function*. The query is a treesitter query string; the
language is a string that identifies the treesitter parser to use; the diff
function maps *query matches* to *diffs*; and the *filter function* is a
predicate that is used to select query matches before they are passed to the
diff function.

### Details

The iterator's job is to traverse the file and perform a transform on each
query match. Because IFactor allows the user to arbitrarily edit the file in
between matches, this requires some non-trivial logic. Therefore, the preferred way
to construct a query transform iterator is to call
`ifactor.utils.make_query_transform_iterator`.

The **query transform iterator** is an [iterator
function](https://www.lua.org/pil/7.1.html). It takes a buffer number, file
cursor, and "dirty" flag as parameters, and yields an incremented file cursor
and *diff* in response. The file cursor is a simple table encoding *(line,
character)* coordinates within a file; the "dirty" flag is a boolean indicating
whether the buffer has been modified since last being written; and the diff is
a list of [LSP TextEdit][lsp-text-edit] objects, which pair a range of
line/character coordinates with some text.

[lsp-text-edit]: https://microsoft.github.io/language-server-protocol/specifications/lsp/3.17/specification/#textEdit

The options taken by `Instance` are:

- `cwd`: root directory for glob file discovery
- `mappings`: a table mapping any subset of the four IFactor commands to Vim
  keysequences. The key sequences are passed as is to
  `vim.api.nvim_buf_set_keymap`.
